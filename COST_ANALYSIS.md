# プラン別コスト分析

## 1. 画像サイズの想定

### LP監視のスクリーンショット
- **解像度**: 1280x800 (ビューポート) + フルページ（ページ高さに依存）
- **形式**: **JPEG**（品質80%、実装済み）
- **平均サイズ**: **1.5MB**（元のPNG 3MBから約50%削減）

### クリエイティブ監視の画像
- **解像度**: 元の画像サイズに依存
- **形式**: **JPEG**（品質80%、実装済み）
- **平均サイズ**: **250KB**（元のPNG 500KBから約50%削減）

### 差分画像（LP監視のみ）
- **形式**: **JPEG**（品質80%、実装済み）
- **平均サイズ**: **1MB**（元のPNG 2MBから約50%削減）

### 画像保存ロジック
- **LP監視**:
  - **初回登録時**: 必ず1枚保存（1.5MB）
  - 変更があった場合: 新しいスクリーンショット(1.5MB) + 差分画像(1MB) = **2.5MB/回**
  - 変更がない場合: 最新の1枚のみ保持（以前の画像は削除）
- **クリエイティブ監視**:
  - **初回登録時**: 必ず1枚保存（250KB）
  - 変更があった場合: 新しい画像 = **250KB/回**
  - 変更がない場合: 最新の1枚のみ保持（以前の画像は削除）

## 2. Supabase料金体系（2024年12月時点）

### Freeプラン
- **料金**: 無料
- **ストレージ**: 1GB
- **帯域幅**: 5GB/月
- **データベース**: 500MB
- **超過料金**: ストレージ $0.021/GB、帯域幅 $0.09/GB

### Proプラン
- **料金**: $25/月（基本料金）
- **ストレージ**: 100GB（超過分 $0.021/GB）
- **帯域幅**: 250GB/月（超過分 $0.09/GB）
- **データベース**: 8GB（超過分 $0.125/GB）
- **バックアップ**: 7日分

## 3. プラン別使用量の計算

### 仮定
1. **変更検出率**: 監視回数の10%（90%は変更なし、10%は変更ありと仮定）
2. **監視頻度**: プランに応じた最小監視間隔で自動監視を実行
   - Free: 14日ごと
   - Light: 7日ごと
   - Pro: 3日ごと
3. **手動監視**: プランの上限まで実行
   - Free: 5回/日
   - Light: 50回/日
   - Pro: 200回/日
4. **初回登録時**: LP/クリエイティブ登録時に必ず1枚の画像を保存
5. **保存期間**: プランに応じた履歴保持期間が経過した古いデータは自動削除
   - Free: 30日
   - Light: 90日
   - Pro: 365日

### Freeプラン（最大LP数: 3、最大クリエイティブ数: 10、最小間隔: 14日、手動監視: 5回/日）

#### 初回登録時の画像保存
- **LP登録時**: 3枚 × 1.5MB = **4.5MB**
- **クリエイティブ登録時**: 10枚 × 250KB = **2.5MB**

#### 自動監視（最小間隔: 14日）
- **LP監視回数/月**: 3 LP × (30日 / 14日) ≈ **6回**（2.14回/LP、切り上げ）
- **クリエイティブ監視回数/月**: 10 × (30日 / 14日) ≈ **21回**（2.1回/クリエイティブ）
- **変更があった場合**:
  - LP: 6回 × 10% × 2.5MB = **1.5MB**
  - クリエイティブ: 21回 × 10% × 250KB ≈ **0.5MB**
- **変更がない場合（最新1枚のみ保持）**:
  - LP: 3枚 × 1.5MB = **4.5MB**
  - クリエイティブ: 10枚 × 250KB = **2.5MB**

#### 手動監視（上限: 5回/日）
- **最大手動監視回数/月**: 5回/日 × 30日 = **150回**
- **LPとクリエイティブの合計が150回を上限**
- **変更があった場合（仮に平均10%、LP/クリエイティブの平均）**:
  - LP比率50%と仮定: 75回 × 10% × 2.5MB ≈ **18.75MB**
  - クリエイティブ比率50%と仮定: 75回 × 10% × 250KB ≈ **1.875MB**
  - 合計: **約20.6MB**

#### ストレージ合計
- **保存画像（最新1枚のみ保持）**: 4.5MB + 2.5MB = **7MB**
- **月間アップロード**: 1.5MB + 0.5MB + 20.6MB = **22.6MB**
- **月間ダウンロード（比較用）**: 6回 + 21回 + 150回 = 177回の監視で、変更があった場合のみ画像をダウンロード
  - 変更率10%と仮定: 177回 × 10% × 1.5MB（LP平均、クリエイティブは小さいが計算簡略化のため） ≈ **26.6MB**

#### 帯域幅合計
- **アップロード**: 22.6MB
- **ダウンロード**: 26.6MB
- **合計**: **49.2MB**（約0.05GB）

#### Freeプランでのコスト
- **ストレージ使用量**: 7MB（1GB内）✅
- **帯域幅**: 0.05GB（5GB内）✅
- **データベース**: 想定500MB以下 ✅
- **月額コスト**: **$0**（無料枠内）

---

### Lightプラン（最大LP数: 10、最大クリエイティブ数: 30、最小間隔: 7日、手動監視: 50回/日）

#### 初回登録時の画像保存
- **LP登録時**: 10枚 × 1.5MB = **15MB**
- **クリエイティブ登録時**: 30枚 × 250KB = **7.5MB**

#### 自動監視（最小間隔: 7日）
- **LP監視回数/月**: 10 LP × (30日 / 7日) ≈ **43回**（4.3回/LP）
- **クリエイティブ監視回数/月**: 30 × (30日 / 7日) ≈ **129回**（4.3回/クリエイティブ）
- **変更があった場合**:
  - LP: 43回 × 10% × 2.5MB ≈ **10.75MB**
  - クリエイティブ: 129回 × 10% × 250KB ≈ **3.225MB**
- **変更がない場合（最新1枚のみ保持）**:
  - LP: 10枚 × 1.5MB = **15MB**
  - クリエイティブ: 30枚 × 250KB = **7.5MB**

#### 手動監視（上限: 50回/日）
- **最大手動監視回数/月**: 50回/日 × 30日 = **1,500回**
- **変更があった場合（仮に平均10%、LP/クリエイティブの平均）**:
  - LP比率50%と仮定: 750回 × 10% × 2.5MB = **187.5MB**
  - クリエイティブ比率50%と仮定: 750回 × 10% × 250KB ≈ **18.75MB**
  - 合計: **約206.25MB**

#### ストレージ合計
- **保存画像（最新1枚のみ保持）**: 15MB + 7.5MB = **22.5MB**
- **月間アップロード**: 10.75MB + 3.225MB + 206.25MB ≈ **220.2MB**
- **月間ダウンロード**: (43 + 129 + 1,500) × 10% × 1.5MB（LP平均、計算簡略化のため） ≈ **250.8MB**

#### 帯域幅合計
- **アップロード**: 220.2MB
- **ダウンロード**: 250.8MB
- **合計**: **471MB**（約0.47GB）

#### Lightプランでのコスト（Freeプラン使用時）
- **ストレージ使用量**: 22.5MB（1GB内）✅
- **帯域幅**: 0.47GB（5GB内）✅
- **データベース**: 想定500MB以下 ✅
- **月額コスト**: **$0**（Freeプランで十分）

---

### Proプラン（最大LP数: 100、最大クリエイティブ数: 300、最小間隔: 3日、手動監視: 200回/日）

#### 想定使用量（上限の一部を使用）
- **LP数**: 100（上限いっぱい）
- **クリエイティブ数**: 300（上限いっぱい）

#### 初回登録時の画像保存
- **LP登録時**: 100枚 × 1.5MB = **150MB**
- **クリエイティブ登録時**: 300枚 × 250KB = **75MB**

#### 自動監視（最小間隔: 3日）
- **LP監視回数/月**: 100 LP × (30日 / 3日) = **1,000回**
- **クリエイティブ監視回数/月**: 300 × (30日 / 3日) = **3,000回**
- **変更があった場合**:
  - LP: 1,000回 × 10% × 2.5MB = **250MB**
  - クリエイティブ: 3,000回 × 10% × 250KB = **75MB**
- **変更がない場合（最新1枚のみ保持）**:
  - LP: 100枚 × 1.5MB = **150MB**
  - クリエイティブ: 300枚 × 250KB = **75MB**

#### 手動監視（上限: 200回/日）
- **最大手動監視回数/月**: 200回/日 × 30日 = **6,000回**
- **変更があった場合（仮に平均10%、LP/クリエイティブの平均）**:
  - LP比率50%と仮定: 3,000回 × 10% × 2.5MB = **750MB**
  - クリエイティブ比率50%と仮定: 3,000回 × 10% × 250KB = **75MB**
  - 合計: **825MB**

#### ストレージ合計
- **保存画像（最新1枚のみ保持）**: 150MB + 75MB = **225MB**
- **月間アップロード**: 250MB + 75MB + 825MB = **1,150MB**（約1.15GB）
- **月間ダウンロード**: (1,000 + 3,000 + 6,000) × 10% × 1.5MB（LP平均、計算簡略化のため） = **1,500MB**（約1.5GB）

#### 帯域幅合計
- **アップロード**: 1.15GB
- **ダウンロード**: 1.5GB
- **合計**: **2.65GB**

#### Proプランでのコスト
- **基本料金**: **$25/月**
- **ストレージ使用量**: 225MB（100GB内）✅ 追加料金なし
- **帯域幅**: 2.65GB（250GB内）✅ 追加料金なし
- **データベース**: 想定8GB以下 ✅ 追加料金なし
- **月額コスト**: **$25**（追加料金なし）

---

### Adminプラン（LP数: 無制限、クリエイティブ数: 無制限、最小間隔: 1日、手動監視: 無制限）

#### 想定使用量（大規模運用の例）
- **LP数**: 200（例）
- **クリエイティブ数**: 500（例）

#### 初回登録時の画像保存
- **LP登録時**: 200枚 × 1.5MB = **300MB**
- **クリエイティブ登録時**: 500枚 × 250KB = **125MB**

#### 自動監視（最小間隔: 1日）
- **LP監視回数/月**: 200 LP × 30日 = **6,000回**
- **クリエイティブ監視回数/月**: 500 × 30日 = **15,000回**
- **変更があった場合**:
  - LP: 6,000回 × 10% × 2.5MB = **1,500MB**（1.5GB）
  - クリエイティブ: 15,000回 × 10% × 250KB = **375MB**
- **変更がない場合（最新1枚のみ保持）**:
  - LP: 200枚 × 1.5MB = **300MB**
  - クリエイティブ: 500枚 × 250KB = **125MB**

#### 手動監視（上限: 無制限）
- **想定手動監視回数/月**: 500回/日 × 30日 = **15,000回**（例）
- **変更があった場合（仮に平均10%、LP/クリエイティブの平均）**:
  - LP比率50%と仮定: 7,500回 × 10% × 2.5MB = **1,875MB**（約1.88GB）
  - クリエイティブ比率50%と仮定: 7,500回 × 10% × 250KB = **187.5MB**
  - 合計: **約2.06GB**

#### ストレージ合計
- **保存画像（最新1枚のみ保持）**: 300MB + 125MB = **425MB**
- **月間アップロード**: 1,500MB + 375MB + 2,060MB = **3,935MB**（約3.94GB）
- **月間ダウンロード**: (6,000 + 15,000 + 15,000) × 10% × 1.5MB（LP平均、計算簡略化のため） = **5,400MB**（約5.4GB）

#### 帯域幅合計
- **アップロード**: 3.94GB
- **ダウンロード**: 5.4GB
- **合計**: **9.34GB**

#### Adminプランでのコスト（Proプラン使用時）
- **基本料金**: **$25/月**
- **ストレージ使用量**: 425MB（100GB内）✅ 追加料金なし
- **帯域幅**: 9.34GB（250GB内）✅ 追加料金なし
- **データベース**: 想定8GB以下 ✅ 追加料金なし
- **月額コスト**: **$25**（追加料金なし）

**注意**: Adminプランは大規模運用を想定しているため、実際の使用量によってはSupabase Proプランの制限を超える可能性があります。その場合は、Supabase Teamプラン（$599/月）へのアップグレードを検討する必要があります。

---

## 4. まとめ

### プラン別月額コスト（Supabase）

| プラン | Supabase料金 | ストレージ使用量 | 帯域幅使用量 | 備考 |
|--------|-------------|----------------|------------|------|
| **Free** | **$0** | 7MB / 1GB | 0.05GB / 5GB | 無料枠内で十分 |
| **Light** | **$0** | 22.5MB / 1GB | 0.47GB / 5GB | Freeプランで十分 |
| **Pro** | **$25** | 225MB / 100GB | 2.65GB / 250GB | 追加料金なし |
| **Admin** | **$25** | 425MB / 100GB | 9.34GB / 250GB | 追加料金なし（中規模運用時） |

### 結論

1. **Free/Lightプラン**: SupabaseのFreeプラン（無料）で十分対応可能
2. **Proプラン**: SupabaseのProプラン（$25/月）で対応可能。追加料金は発生しない見込み
3. **Adminプラン**: 中規模運用（LP 200、クリエイティブ 500程度）まではSupabase Proプランで対応可能。大規模運用の場合はTeamプランへのアップグレードを検討

### コスト削減の実装済み施策

1. **✅ 画像の圧縮**: PNGからJPEG（品質80%）への変換で約50%のサイズ削減（実装済み）
2. **✅ 保存期間の制限**: プランごとに監視履歴の保存期間を設定し、古いデータを自動削除（実装済み）
   - Free: 30日
   - Light: 90日
   - Pro: 365日
3. **✅ 変更がない場合の画像削除**: 最新の1枚のみ保持し、古い画像は削除（実装済み）

### 注意事項

- **変更検出率10%は仮定値**：実際の使用状況によって変動
- **LP画像サイズは1.5MB（JPEG圧縮後）で見積もり**：実際のページの複雑さによって変動する可能性あり
- **保存画像は最新1枚のみ**：変更がない場合は古い画像は削除されるため、ストレージ使用量は抑えられる
- **初回登録時の画像保存を考慮**：LP/クリエイティブ登録時に必ず1枚の画像が保存される
- **データベース容量**：監視履歴の保存期間やデータ量によって変動。プランごとの履歴保持期間に応じて自動クリーンアップが実行される
- **JPEG圧縮の効果**：品質80%で約50%のサイズ削減を実現。品質とサイズのバランスが取れている

### 監視間隔による影響

プラン設定が変更され、監視間隔が長くなったことで：
- **Freeプラン**: 3日 → 14日に変更により、監視回数が約1/4.7に削減（コスト大幅削減）
- **Lightプラン**: 3日 → 7日に変更により、監視回数が約1/2.3に削減（コスト削減）
- **Proプラン**: 1日 → 3日に変更により、監視回数が約1/3に削減（コスト削減）

これにより、JPEG圧縮と合わせて、全体的に大幅なコスト削減が実現されています。
