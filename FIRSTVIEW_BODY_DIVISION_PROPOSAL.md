# ファーストビューとボディーの区分け案

## 現在の状況

### スクリーンショット撮影設定
- ビューポートサイズ: `1280x800`（`server/monitoring.ts:24`）
- 撮影方法: `fullPage: true`（ページ全体を撮影）

### 現在の区分け方法
- 画像の高さを3等分（上部・中部・下部）
- 各領域は `height / 3` の高さ

## ファーストビューとボディーの区分け案

### 案1: 固定高さで区分（推奨）

**概要**: ファーストビューを固定高さ（例：800px）で定義し、それ以降をボディーとする

**メリット**:
- ファーストビューを正確に捉えられる
- PCモニターの一般的な画面サイズに合わせやすい
- 実装が簡単

**実装方法**:
```typescript
const FIRSTVIEW_HEIGHT = 800; // PCモニターの一般的なファーストビュー高さ

// ファーストビュー: y = 0 ～ FIRSTVIEW_HEIGHT
// ボディー: y = FIRSTVIEW_HEIGHT ～ height
```

**考慮事項**:
- ページの高さが800px未満の場合、ボディーが存在しない
- モバイルとPCで異なる可能性があるが、現在はPCのみ想定

---

### 案2: ビューポートサイズに基づく区分

**概要**: スクリーンショット撮影時のビューポートサイズ（800px）をファーストビューとする

**メリット**:
- 撮影時の設定と一致している
- より正確にファーストビューを捉えられる

**実装方法**:
```typescript
const FIRSTVIEW_HEIGHT = 800; // ビューポートの高さと同じ

// ファーストビュー: y = 0 ～ FIRSTVIEW_HEIGHT
// ボディー: y = FIRSTVIEW_HEIGHT ～ height
```

**考慮事項**:
- ビューポートサイズが変更された場合、定数の更新が必要

---

### 案3: 動的なファーストビュー検出（将来的な改善案）

**概要**: ページの内容構造を解析して、ファーストビューの境界を自動検出

**メリット**:
- より柔軟で正確な区分が可能
- 様々なページレイアウトに対応

**デメリット**:
- 実装が複雑
- 処理時間が増加する可能性

**実装方法**:
- DOM構造を解析して、主要コンテンツの開始位置を検出
- または、画像の色や構造パターンを分析

---

## 推奨案: 案1（固定高さ800px）

**理由**:
1. 実装が簡単で確実
2. PCモニターの一般的な画面サイズに合致
3. 現在のビューポートサイズ（800px）と一致
4. 将来的に改善する余地がある

---

## 変更検出パターンの整理案

### 現在のパターン（3領域：上部・中部・下部）

1. **変更なし**: 全体差分 < 1%
2. **軽微な変更**: 全体差分 >= 1% かつ 全領域 < 5%
3. **ファーストビューのみ変更**: 上部 > 5% かつ 上部 > 中部×2 かつ 上部 > 下部×2
4. **特定領域のみ大きく変更**: 1領域のみ > 5%
5. **複数領域が大きく変更**: 2領域 > 5%
6. **ページ全体が大きく変更**: 全領域 > 5%

### 新しいパターン（2領域：ファーストビュー・ボディー）

#### パターン1: 変更なし
- **条件**: 全体差分 < 3%（新しい閾値）
- **ステータス**: `ok`
- **メッセージ**: `変更なし`

#### パターン2: 軽微な変更
- **条件**: 
  - 全体差分 >= 3% かつ < 5%
  - かつ、ファーストビュー < 5% かつ ボディー < 5%
- **ステータス**: `ok`（変更なしとして扱う）または `changed`（要検討）
- **メッセージ**: `軽微な変更あり（変更なしとして扱う）` または `軽微な変更あり`

#### パターン3: ファーストビューのみ変更
- **条件**: 
  - ファーストビュー > 5%
  - かつ、ボディー < 5%
  - かつ、ファーストビュー > ボディー × 2（突出している）
- **ステータス**: `changed`
- **メッセージ**: `ファーストビューのみ変更あり（差分: {ファーストビュー差分}%）`

#### パターン4: ボディーのみ変更
- **条件**: 
  - ボディー > 5%
  - かつ、ファーストビュー < 5%
  - かつ、ボディー > ファーストビュー × 2（突出している）
- **ステータス**: `changed`
- **メッセージ**: `ボディーのみ変更あり（差分: {ボディー差分}%）`

#### パターン5: ファーストビューとボディー両方が変更
- **条件**: 
  - ファーストビュー > 5% かつ ボディー > 5%
- **ステータス**: `changed`
- **メッセージ**: `ページ全体が大きく変更されています（ファーストビュー: {X}%、ボディー: {Y}%）`

#### パターン6: ファーストビューとボディー両方が軽微な変更
- **条件**: 
  - 全体差分 >= 3% かつ < 5%
  - かつ、（ファーストビュー >= 5% または ボディー >= 5%）
  - ただし、どちらも5%未満でも、全体で3%以上
- **ステータス**: `changed`（要検討）
- **メッセージ**: `軽微な変更あり（ファーストビュー: {X}%、ボディー: {Y}%）`

---

## 変更検出パターンの整理表

| パターン | 全体差分 | ファーストビュー | ボディー | ステータス | メッセージ例 |
|---------|---------|----------------|---------|-----------|------------|
| 変更なし | < 3% | - | - | `ok` | 変更なし |
| 軽微な変更 | 3-5% | < 5% | < 5% | `ok` または `changed` | 軽微な変更あり |
| ファーストビューのみ | >= 3% | > 5% | < 5% | `changed` | ファーストビューのみ変更あり |
| ボディーのみ | >= 3% | < 5% | > 5% | `changed` | ボディーのみ変更あり |
| 全体変更 | >= 3% | > 5% | > 5% | `changed` | ページ全体が大きく変更されています |

---

## 実装時の考慮事項

### 1. 軽微な変更の扱い
- **オプションA**: 軽微な変更（3-5%）も「変更なし」として扱う
  - ノイズやレンダリングの微妙な違いを無視
  - ユーザーへの通知を減らせる
- **オプションB**: 軽微な変更も「変更検出」として扱う
  - すべての変更を記録
  - ユーザーが詳細を確認できる

### 2. ファーストビュー突出判定
- 現在は「×2」の倍率で判定
- より厳密にする場合は「×3」や「×5」も検討可能

### 3. メッセージの詳細度
- 差分率を含めるかどうか
- 領域別の差分率を表示するかどうか

### 4. データベースへの保存
- `diffTopThird`, `diffMiddleThird`, `diffBottomThird` を
- `diffFirstView`, `diffBody` に変更する必要がある

---

## 推奨される実装方針

1. **ファーストビュー高さ**: 固定800px（案1）
2. **変更検出パターン**: 上記の6パターン
3. **軽微な変更の扱い**: オプションA（変更なしとして扱う）を推奨
4. **メッセージ**: 差分率を含めて、わかりやすく表示

---

## 質問事項

1. 軽微な変更（3-5%）は「変更なし」として扱いますか？それとも「変更検出」として扱いますか？
2. ファーストビュー突出判定の倍率（×2）は適切ですか？
3. メッセージに差分率を含めますか？
4. データベーススキーマの変更（`diffTopThird` → `diffFirstView`など）は問題ありませんか？

