# 監視ロジックの分析

## 現在の変更検出ロジック

### 1. 変更検出の閾値（`server/monitoring.ts:451`）
```typescript
// Consider changed if difference is more than 1%
if (diffPercentage > 1) {
  contentChanged = true;
}
```
- **現在の閾値**: `1%`（厳密には `> 1`）
- **問題**: 1.16%のような小さな差分でも「変更検出」として扱われる

### 2. 領域別分析のロジック（`server/monitoring.ts:296-327`）

#### 閾値の定義
- `significantThreshold = 5.0%`: 重要な変更とみなす閾値
- `minorThreshold = 1.0%`: 軽微な変更とみなす閾値

#### 分析パターン

1. **変更なし** (`overall < 1.0%`)
   - 条件: 全体差分が1%未満
   - 分析結果: "変更なし"

2. **ファーストビューのみ変更** (`topDominant`)
   - 条件:
     - 上部差分 > 5%
     - 上部差分 > 中部差分 × 2
     - 上部差分 > 下部差分 × 2
   - 分析結果: "ファーストビュー(上部)のみ変更あり"

3. **軽微な変更** (`changedRegions.length === 0`)
   - 条件:
     - 全体差分 >= 1%
     - かつ、上部・中部・下部すべてが5%未満
   - 分析結果: "軽微な変更あり"

4. **ページ全体が大きく変更** (`changedRegions.length === 3`)
   - 条件: 上部・中部・下部すべてが5%以上
   - 分析結果: "ページ全体が大きく変更されています"

5. **特定領域のみ大きく変更** (`changedRegions.length === 1`)
   - 条件: 上部・中部・下部のうち1つだけが5%以上
   - 分析結果: "{領域名}のみ大きく変更されています"

6. **複数領域が大きく変更** (`changedRegions.length === 2`)
   - 条件: 上部・中部・下部のうち2つが5%以上
   - 分析結果: "{領域1}と{領域2}が大きく変更されています"

## 変更検出パターンの全リスト

### パターン1: リンク切れ
- **検出条件**: URLにアクセスできない（HTTPエラー、タイムアウトなど）
- **ステータス**: `error`
- **checkType**: `link_broken`
- **メッセージ**: `リンク切れを検出: {エラー詳細}`

### パターン2: 変更なし
- **検出条件**: 
  - 全体差分 < 1%
  - または、前回のスクリーンショットがない（初回監視）
- **ステータス**: `ok`
- **checkType**: `content_change`
- **メッセージ**: `変更なし`

### パターン3: 軽微な変更（現在は変更検出として扱われる）
- **検出条件**: 
  - 全体差分 >= 1% かつ < 5%
  - かつ、上部・中部・下部すべてが5%未満
- **ステータス**: `changed`（現在）
- **checkType**: `content_change`
- **メッセージ**: `コンテンツ変更を検出 (差分: {X}%) - 軽微な変更あり`
- **問題**: 1.16%のような小さな差分でも「変更検出」になる

### パターン4: ファーストビューのみ変更
- **検出条件**:
  - 上部差分 > 5%
  - 上部差分 > 中部差分 × 2
  - 上部差分 > 下部差分 × 2
- **ステータス**: `changed`
- **checkType**: `content_change`
- **メッセージ**: `コンテンツ変更を検出 (差分: {X}%) - ファーストビュー(上部)のみ変更あり`

### パターン5: 特定領域のみ大きく変更
- **検出条件**: 上部・中部・下部のうち1つだけが5%以上
- **ステータス**: `changed`
- **checkType**: `content_change`
- **メッセージ**: `コンテンツ変更を検出 (差分: {X}%) - {領域名}のみ大きく変更されています`

### パターン6: 複数領域が大きく変更
- **検出条件**: 上部・中部・下部のうち2つが5%以上
- **ステータス**: `changed`
- **checkType**: `content_change`
- **メッセージ**: `コンテンツ変更を検出 (差分: {X}%) - {領域1}と{領域2}が大きく変更されています`

### パターン7: ページ全体が大きく変更
- **検出条件**: 上部・中部・下部すべてが5%以上
- **ステータス**: `changed`
- **checkType**: `content_change`
- **メッセージ**: `コンテンツ変更を検出 (差分: {X}%) - ページ全体が大きく変更されています`

### パターン8: 画像サイズ不一致
- **検出条件**: 前回と今回のスクリーンショットのサイズが異なる
- **処理**: リサイズして比較（ただし、差分が大きくなる可能性）
- **ステータス**: `changed`（差分が大きい場合）
- **checkType**: `content_change`

### パターン9: スクリーンショット撮影エラー
- **検出条件**: Puppeteerでスクリーンショット撮影に失敗
- **現在の処理**: エラーをthrow（エラーレコードとして保存されない）
- **問題**: ユーザーにエラーが通知されない可能性

## 推奨される修正案

### 案1: 閾値を2%または3%に引き上げ
- 1%未満: 変更なし
- 1%以上2%（または3%）未満: 軽微な変更（変更なしとして扱う？）
- 2%（または3%）以上: 変更検出

### 案2: 領域別の閾値を考慮
- 全体差分が1%以上でも、全領域が5%未満なら「軽微な変更」として扱う
- 「軽微な変更」は「変更なし」として扱うか、別のステータスにするか

### 案3: 動的閾値
- 過去の履歴から平均的な変動幅を計算し、それを基準にする
- サイトの特性に応じて閾値を調整

### 案4: ノイズフィルタリング
- 1-2%の差分は、時間の経過やレンダリングの微妙な違いによるノイズの可能性が高い
- 複数回連続で検出された場合のみ「変更検出」とする

## 質問事項

1. 1.16%のような小さな差分を「変更なし」としたい場合、どの程度の閾値が適切か？
   - 2%？
   - 3%？
   - それとも領域別の閾値も考慮する？

2. 「軽微な変更」はどう扱うべきか？
   - 「変更なし」として扱う？
   - 別のステータスとして扱う？
   - ログに記録するが、通知はしない？

3. スクリーンショット撮影エラーはどう扱うべきか？
   - エラーレコードとして保存する？
   - ユーザーに通知する？

