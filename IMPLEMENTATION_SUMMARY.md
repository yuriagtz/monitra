# LP監視システム 実装完了サマリー

## 🎉 実装完了した全機能

### 1. ✅ レイアウト改修とダッシュボード
- **DashboardLayout導入**: サイドバーナビゲーション + ヘッダー
- **ダッシュボードページ**: 登録LP数、正常チェック数、変更検出数、エラー数をカード表示
- **最近の監視履歴**: 直近10件の監視結果を一覧表示

### 2. ✅ 検索・フィルター・タグ機能
- **LP検索**: タイトル、URL、説明でリアルタイム検索
- **タグ機能**: カラフルなタグを作成してLPをカテゴリ分類
- **タグフィルター**: プルダウンでタグ別に絞り込み
- **タグ管理**: 設定ページでタグの作成・削除・色選択

### 3. ✅ 分析レポート機能
- **変更頻度グラフ**: LP別の変更回数を棒グラフで可視化
- **変更トレンドチャート**: 日別の変更推移を折れ線グラフで表示
- **統計サマリー**: 平均変更検出率、最も変更が多いLP、総チェック回数
- **LP選択**: ドロップダウンで全体または個別LPの分析

### 4. ✅ 通知機能
- **4つの通知チャネル**: メール、Slack、Discord、Chatwork
- **通知条件設定**: 変更検出時、エラー時、リンク切れ、ファーストビューのみ除外
- **テスト送信機能**: 各チャネルの動作確認
- **個別有効化**: チャネルごとに有効/無効を切り替え

### 5. ✅ 自動監視スケジュール機能
- **2つのスケジュールモード**: 間隔(分単位)、Cron式
- **LP別設定**: 各LPに個別のスケジュールを設定
- **スケジュール実行エンジン**: node-cronによる自動実行
- **開始/停止制御**: スケジュールの有効化・無効化

### 6. ✅ 高度な差分検出機能
- **特定領域監視**: ヘッダー、メインコンテンツ、フッターを個別に分析
- **テキスト変更検出**: Tesseract.js OCRで文字抽出・比較
- **色変更検出**: 主要色を抽出して色の変化を検出
- **領域別差分率**: 上部・中部・下部の3領域で差分を計算

### 7. ✅ インポート/エクスポート機能
- **CSV一括登録**: LP情報をCSVファイルから一括インポート
- **LPリストエクスポート**: 登録LP一覧をCSV出力
- **監視履歴エクスポート**: 全監視履歴をCSV出力
- **完全バックアップ**: LP・履歴を含む全データをJSON出力

---

## 📊 技術スタック

### フロントエンド
- React 19 + TypeScript
- Tailwind CSS 4 + shadcn/ui
- tRPC (型安全なAPI通信)
- Recharts (グラフ・チャート)
- Wouter (ルーティング)

### バックエンド
- Express 4
- tRPC 11
- Puppeteer (スクリーンショット撮影)
- Pixelmatch (画像比較)
- Sharp (画像処理)
- Tesseract.js (OCR)
- node-cron (スケジュール実行)

### データベース
- MySQL/TiDB
- Drizzle ORM

### 認証・ストレージ
- Manus OAuth
- S3互換オブジェクトストレージ

---

## 🗂️ データベーススキーマ

### テーブル一覧
1. **users**: ユーザー情報(OAuth認証)
2. **landing_pages**: 登録LP情報
3. **monitoring_history**: 監視履歴
4. **screenshots**: スクリーンショット情報
5. **tags**: タグマスター
6. **landing_page_tags**: LP-タグ関連
7. **notification_settings**: 通知設定
8. **schedule_settings**: スケジュール設定

---

## 🎨 主要機能の画面構成

### サイドバーメニュー
- 📊 ダッシュボード
- 📝 LP管理
- 📈 分析レポート
- 🔔 通知設定
- ⏰ スケジュール
- 📥 インポート/エクスポート
- ⚙️ 設定

### LP管理画面
- 検索バー(タイトル/URL/説明)
- タグフィルター(プルダウン)
- LP登録ボタン
- LP一覧テーブル(タイトル、URL、最終チェック、ステータス、アクション)
- アクション: 手動チェック(🔄)、履歴表示(👁)、タグ追加(🏷)、削除(🗑)

### 監視履歴画面
- LP情報表示
- 履歴一覧テーブル(日時、種類、ステータス、メッセージ、領域分析)
- 画像表示ボタン(現在・前回・差分のスクリーンショット)

### 分析レポート画面
- LP選択ドロップダウン
- 変更頻度棒グラフ
- 変更トレンド折れ線グラフ
- 統計サマリーカード

### 通知設定画面
- メール設定(SMTP情報)
- Slack設定(Webhook URL)
- Discord設定(Webhook URL)
- Chatwork設定(APIトークン、ルームID)
- 通知条件チェックボックス
- テスト送信ボタン

### スケジュール設定画面
- LP選択ドロップダウン
- スケジュールタイプ選択(間隔/Cron)
- 間隔設定(分)
- Cron式入力
- 有効/無効トグル
- 保存ボタン

### インポート/エクスポート画面
- CSVファイル選択(インポート)
- CSVフォーマット例
- LPリストエクスポートボタン
- 監視履歴エクスポートボタン
- 完全バックアップ(JSON)ボタン
- データ統計表示

### 設定画面
- タグ管理セクション
  - タグ名入力
  - 色選択
  - タグ追加ボタン
  - タグ一覧(削除ボタン付き)

---

## 🚀 主要機能の動作フロー

### 1. LP監視の基本フロー
```
1. ユーザーがLPを登録
2. 手動チェックまたはスケジュール実行
3. Puppeteerでスクリーンショット撮影
4. 前回のスクリーンショットと比較
   - Pixelmatchで画像差分を計算
   - 上部・中部・下部の3領域で個別に差分率を算出
   - 領域別差分率から「ファーストビューのみ変更」などを判定
5. リンク切れチェック(HTTPステータス確認)
6. 結果をデータベースに保存
7. 通知条件に合致する場合、設定された通知チャネルに送信
```

### 2. 領域別差分検出フロー
```
1. 前回と今回のスクリーンショットを取得
2. 画像サイズを揃える(Sharpでリサイズ)
3. 画像を3つの領域に分割
   - 上部: 0-33% (ファーストビュー)
   - 中部: 33-66%
   - 下部: 66-100%
4. 各領域でPixelmatchを実行
5. 領域別の差分率を計算
6. 分析結果を生成
   - 上部の差分率が他より20%以上高い → 「ファーストビュー(上部)のみ変更あり」
   - 全領域が1%以上 → 「ページ全体が変更されています」
   - 全領域が1%未満 → 「変更なし」
```

### 3. 高度な差分検出フロー(OCR・色)
```
1. テキスト変更検出
   - Tesseract.jsで前回・今回の画像からテキスト抽出
   - Levenshtein距離で類似度を計算
   - 95%未満の類似度で「テキスト変更あり」と判定

2. 色変更検出
   - Sharpで画像を100x100にリサイズ
   - 色を32段階に量子化
   - 出現頻度の高い上位5色を抽出
   - 前回と今回の主要色を比較
   - 70%未満の一致率で「色変更あり」と判定

3. 特定領域監視
   - ヘッダー(0-15%)、メインコンテンツ(15-85%)、フッター(85-100%)
   - 各領域で個別に差分を計算
   - 1%以上の差分で「変更あり」と判定
```

### 4. 自動監視スケジュールフロー
```
1. ユーザーがLP別にスケジュールを設定
2. スケジュールタイプを選択
   - 間隔: X分ごとに実行
   - Cron: cron式で実行タイミングを指定
3. 有効化すると、node-cronにスケジュールを登録
4. 指定時刻になると自動的に監視を実行
5. 結果をデータベースに保存
6. 通知条件に合致する場合、通知を送信
```

### 5. 通知送信フロー
```
1. 監視チェック完了後、通知設定を取得
2. 通知条件を確認
   - 変更検出時のみ通知 → 差分率が閾値以上
   - エラー時のみ通知 → ステータスがエラー
   - リンク切れ → HTTPステータスが400以上
   - ファーストビューのみ除外 → 領域分析結果を確認
3. 条件に合致する場合、有効化された通知チャネルに送信
   - メール: SMTP経由で送信
   - Slack: Webhook URLにPOST
   - Discord: Webhook URLにPOST
   - Chatwork: API経由でメッセージ送信
```

---

## 📝 使用方法

### 初回セットアップ
1. Manus OAuthでログイン
2. サイドバーの「LP管理」から「LP登録」ボタンをクリック
3. タイトル、URL、説明を入力して登録
4. (オプション)サイドバーの「設定」でタグを作成
5. (オプション)サイドバーの「通知設定」で通知チャネルを設定
6. (オプション)サイドバーの「スケジュール」で自動監視を設定

### 日常的な使い方
1. **ダッシュボード**で全体の監視状況を確認
2. **LP管理**で手動チェック(🔄アイコン)を実行
3. **分析レポート**で変更トレンドを確認
4. **監視履歴**(👁アイコン)でスクリーンショットと差分を確認

### データ管理
1. **インポート/エクスポート**でLPを一括登録・バックアップ
2. **設定**でタグを管理
3. Management UIの**Database**パネルで直接データを編集

---

## 🎯 実装のハイライト

### 1. 型安全なAPI通信
tRPCにより、フロントエンドとバックエンドで型が完全に同期。APIの変更時もTypeScriptが自動的にエラーを検出します。

### 2. リアルタイム検索・フィルタリング
React Queryのキャッシュ機能により、検索・フィルタリングが瞬時に反応。UXが大幅に向上しています。

### 3. 領域別差分検出
単純な全体差分だけでなく、ページを3領域に分割して個別に分析。「ファーストビューのみ変更」などの詳細な判定が可能です。

### 4. 柔軟な通知システム
4つの通知チャネルに対応し、通知条件を細かく設定可能。ファーストビューのみの変更を除外するなど、ノイズを減らす工夫があります。

### 5. スケジュール実行エンジン
node-cronによる柔軟なスケジュール設定。間隔モードとCronモードの両方に対応し、LP別に個別設定が可能です。

### 6. 高度な画像分析
Pixelmatch(ピクセル差分)、Tesseract.js(OCR)、Sharp(色抽出)を組み合わせた多角的な変更検出。単なる画像比較を超えた高度な分析が可能です。

### 7. データのインポート/エクスポート
CSV形式での一括登録・エクスポート、JSON形式での完全バックアップに対応。大量のLPを管理する場合も効率的です。

---

## 🔧 今後の拡張可能性

### 実装済みの基盤を活用した拡張例
1. **週次/月次レポート**: 分析データをPDF出力
2. **変更箇所のハイライト**: 差分画像に赤枠を追加
3. **特定時間帯のみ監視**: スケジュール設定の拡張
4. **複数バージョンの比較**: 任意の2つの履歴を比較
5. **AIによる変更内容の要約**: OCRテキストをLLMで分析
6. **Webhook連携**: 外部システムへの通知
7. **ロールバック検知**: 以前のバージョンに戻ったことを検出

---

## ✨ まとめ

LP監視システムは、スクリーンショット比較による変更検出を核として、以下の7つの主要機能を実装した完全なWebアプリケーションです:

1. **ダッシュボード**: 監視状況の可視化
2. **検索・フィルター・タグ**: 効率的なLP管理
3. **分析レポート**: データドリブンな意思決定
4. **通知機能**: リアルタイムなアラート
5. **自動監視スケジュール**: 運用の自動化
6. **高度な差分検出**: 多角的な変更分析
7. **インポート/エクスポート**: データの一括管理

最先端のフルスタック技術で構築され、エンタープライズグレードの品質を実現しています。Manus AIとの対話により、さらなる機能拡張も容易に行えます。
